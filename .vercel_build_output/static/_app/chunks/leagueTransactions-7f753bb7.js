import{a as O,b,g as x}from"./leagueUsers-b0fdd0b7.js";import{l as S}from"./index.svelte_svelte&type=style&lang-b0d2c838.js";import{g as A}from"./nflState-b19b4ad8.js";import{t as y,w}from"./news-c1036290.js";import{ae as M}from"./vendor-60eb0dec.js";const U=async(t,e=!1)=>{const r=M(y);if(r.transactions)return{transactions:_(t,r.transactions),currentManagers:r.currentManagers,totals:r.totals,stale:!1};if(!e){let d=await JSON.parse(localStorage.getItem("transactions"));if(d)return d.transactions=_(t,d.transactions),d.stale=!0,d}const o=await A().catch(d=>{console.error(d)});let s=18;o.season_type=="regular"&&(s=o.week);const{transactionsData:n,prevManagers:f,currentManagers:c,currentSeason:l}=await D(s,S).catch(d=>{console.error(d)}),{transactions:u,totals:p}=j(n,f,l,Object.keys(c).length),i={transactions:u,currentManagers:c,totals:p};return localStorage.setItem("transactions",JSON.stringify(i)),y.update(()=>i),{transactions:_(t,u),currentManagers:c,totals:p,stale:!1}},_=(t,e)=>{if(t){const r=3,o=[],s=[];let n=0;for(;(o.length<r||s.length<r)&&n<e.length;)e[n].type=="waiver"&&s.length<r?s.push(e[n]):e[n].type=="trade"&&o.length<r&&o.push(e[n]),n++;return{trades:o,waivers:s}}return e},D=async(t,e)=>{t=t>0?t:1;const r=[],o={};let s=null,n=null;for(;e&&e!=0;){const[i,d,a]=await w(x(e),b(e),O(e)).catch(h=>{console.error(h)});r.push(e);const g=d.rosters,m={};for(const h of g){const v=a[h.owner_id];v?m[h.roster_id]={avatar:`https://sleepercdn.com/avatars/thumbs/${v.avatar}`,name:v.metadata.team_name?v.metadata.team_name:v.display_name}:m[h.roster_id]={avatar:"https://sleepercdn.com/images/v2/icons/player_default.webp",name:"Unknown Manager"}}s||(s=m),n||(n=i.season),o[i.season]=m,e=i.previous_league_id}const f=[];for(const i of r){for(;t>0;)f.push(fetch(`https://api.sleeper.app/v1/league/${i}/transactions/${t}`,{compress:!0})),t--;t=18}const c=await w(...f).catch(i=>{console.error(i)}),l=[];for(const i of c){if(!i.ok)throw new Error(i);l.push(i.json())}const u=await w(...l).catch(i=>{console.error(i)});let p=[];for(const i of u)p=p.concat(i);return{transactionsData:p,prevManagers:o,currentManagers:s,currentSeason:n}},j=(t,e,r,o)=>{const s=[],n={allTime:{},seasons:{}};for(let c=1;c<=o;c++)n.allTime[c]={trade:0,waiver:0};const f=t.sort((c,l)=>l.status_updated-c.status_updated);for(const c of f){const{digestedTransaction:l,season:u,success:p}=J(c,e,r);if(!!p){s.push(l);for(const i of l.rosters){const d=l.type;if(n.allTime[i][d]++,!n.seasons[u]){n.seasons[u]={};for(let a=1;a<=Object.keys(e[u]).length;a++)n.seasons[u][a]={trade:0,waiver:0,manager:e[u][a]}}n.seasons[u][i][d]++}}}return{transactions:s,totals:n}},k=t=>{var e=new Date(t),r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=e.getFullYear(),s=r[e.getMonth()],n=e.getDate(),f=e.getHours(),c=e.getMinutes();return s+" "+n+" "+o+", "+(f%12==0?12:f%12)+":"+c+(f/12>=1?"PM":"AM")},J=(t,e,r)=>{var d;if(t.status=="failed")return{success:!1};const o=[],s=t.roster_ids,n=(d=t.settings)==null?void 0:d.waiver_bid,f=k(t.status_updated),c=parseInt(f.split(",")[0].split(" ")[2]);let l={id:t.transaction_id,date:f,type:"waiver",rosters:s,moves:[]};if(t.type=="trade"&&(l.type="trade"),c!=r){l.previousOwners=[];for(const a of s)l.previousOwners.push(e[c][a])}const u=t.adds,p=t.drops,i=t.draft_picks;for(let a in u)!a||(o.push(a),l.moves.push(T(s,u,p,a,n)));for(let a in p){if(o.indexOf(a)>-1)continue;let g=new Array(s.length).fill(null);!a||(g[s.indexOf(p[a])]={type:"Dropped",player:a},l.moves.push(g))}for(let a of i){let g=new Array(s.length).fill(null);if(g[s.indexOf(a.previous_owner_id)]={type:"trade",pick:{season:a.season,round:a.round,original_owner:null}},a.roster_id!=a.previous_owner_id){const m={original:c!=r?e[c][a.roster_id].name:null,current:a.roster_id};g[s.indexOf(a.previous_owner_id)].pick.original_owner=m}g[s.indexOf(a.owner_id)]="destination",l.moves.push(g)}for(let a of t.waiver_budget){let g=new Array(s.length).fill(null);g[s.indexOf(a.sender)]={type:"trade",budget:{amount:`${a.amount}$`}},g[s.indexOf(a.receiver)]="destination",l.moves.push(g)}return{digestedTransaction:l,season:c,success:!0}},T=(t,e,r,o,s)=>{let n=new Array(t.length).fill(null);return r&&r[o]?(n[t.indexOf(r[o])]={type:"trade",player:o},n[t.indexOf(e[o])]="destination",n):(n[t.indexOf(e[o])]={type:"Added",player:o,bid:s},n)};export{U as g};
